/*
 * Copyright (C) 2016 B3Partners B.V.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
package nl.b3p.imro.harvester.processing;

import nl.b3p.imro.harvester.parser.IMROParser2012_11;
import com.vividsolutions.jts.geom.MultiPolygon;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.List;
import javax.xml.bind.JAXBException;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;
import nl.b3p.imro.harvester.entities.imro.Dubbelbestemming;
import nl.b3p.imro.harvester.entities.imro.Gebiedsaanduiding;
import org.apache.log4j.ConsoleAppender;
import org.apache.log4j.Level;
import org.apache.log4j.Logger;
import org.apache.log4j.PatternLayout;
import org.junit.After;
import org.junit.AfterClass;
import org.junit.Before;
import org.junit.BeforeClass;
import org.junit.Test;
import static org.junit.Assert.*;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.xml.sax.SAXException;

/**
 *
 * @author Meine Toonen meinetoonen@b3partners.nl
 */
public class GeometryConverterTest {

    private GeometryConverter instance = new GeometryConverter();

    public GeometryConverterTest() {
        
        Logger root = Logger.getRootLogger();
        root.addAppender(new ConsoleAppender(new PatternLayout(PatternLayout.TTCC_CONVERSION_PATTERN)));
        Logger.getLogger("org.apache.http").setLevel(Level.OFF);
    }

    @BeforeClass
    public static void setUpClass() {

        Logger root = Logger.getRootLogger();
        root.addAppender(new ConsoleAppender(
                new PatternLayout(PatternLayout.TTCC_CONVERSION_PATTERN)));
    }

    @AfterClass
    public static void tearDownClass() {
    }

    @Before
    public void setUp() {
    }

    @After
    public void tearDown() {
    }

    @Test
    public void testGebiedsaanduiding() throws ParserConfigurationException, SAXException, IOException, XPathExpressionException, TransformerException {
        URL url = this.getClass().getResource("2012.gml");
        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
        DocumentBuilder db = dbf.newDocumentBuilder();
        Document doc = db.parse(url.openStream());
        XPath xPath = XPathFactory.newInstance().newXPath();
        Node node = (Node) xPath.evaluate("/FeatureCollectionIMRO/featureMember/Gebiedsaanduiding/geometrie", doc, XPathConstants.NODE);
        Element el = (Element) node;
        Object mp = instance.convertMultiPolygonGeometry(el);
        assertNotNull(mp);
        assertTrue(mp instanceof MultiPolygon);
        assertFalse(((MultiPolygon)mp).isEmpty());
    }

    @Test
    public void testGebiedsaanduidingViaParser() throws ParserConfigurationException, SAXException, IOException, XPathExpressionException, TransformerException, JAXBException, URISyntaxException {
        URL url = this.getClass().getResource("2012.gml");

        IMROParser2012_11 p = new IMROParser2012_11();
        List<Object> os = p.parseGML(url);
        for (Object o : os) {
            if (o instanceof Gebiedsaanduiding) {
                Gebiedsaanduiding g = (Gebiedsaanduiding) o;
                assertNotNull("Geometrie moet gevuld zijn", g.getGeometrie());
                assertFalse("Geometrie moet gevuld zijn", g.getGeometrie().isEmpty());
            }
        }
    }

    @Test
    public void testDubbelbestemmingViaParser() throws ParserConfigurationException, SAXException, IOException, XPathExpressionException, URISyntaxException, TransformerException, JAXBException {
        URL url = this.getClass().getResource("2012.gml");

        IMROParser2012_11 p = new IMROParser2012_11();
        List<Object> os = p.parseGML(url);
        for (Object o : os) {
            if (o instanceof Dubbelbestemming) {
                Dubbelbestemming g = (Dubbelbestemming) o;
                assertNotNull("Geometrie moet gevuld zijn", g.getGeometrie());
                assertFalse("Geometrie moet gevuld zijn", g.getGeometrie().isEmpty());
            }
        }
    }

    @Test
    public void testBestemmingsplangebied() throws ParserConfigurationException, SAXException, IOException, XPathExpressionException, TransformerException {
        URL url = this.getClass().getResource("2012.gml");
        //  URL url = new URL ("http://files.b3p.nl/imroharvester/NL.IMRO.0297.BGBBP20140020-OW01.gml");
        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
        dbf.setNamespaceAware(false);
        DocumentBuilder db = dbf.newDocumentBuilder();
        Document doc = db.parse(url.openStream());
        XPath xPath = XPathFactory.newInstance().newXPath();
        Node node = (Node) xPath.evaluate("/FeatureCollectionIMRO/featureMember/Bestemmingsplangebied/geometrie", doc, XPathConstants.NODE);
        Element el = (Element) node;

        Object mp = instance.convertMultiPolygonGeometry(el);
        assertNotNull(mp);
        assertTrue(mp instanceof MultiPolygon);
        assertFalse(((MultiPolygon)mp).isEmpty());
    }

    @Test
    public void testGeometryEnkelbestemming2006Parsing() throws SAXException, IOException, ParserConfigurationException, TransformerException {
        // 2006enkelbestemming
        String xml = "<Surface srsName=\"urn:ogc:def:crs:EPSG::28992\"><patches><PolygonPatch><exterior><Ring><curveMember><Curve><segments><LineStringSegment><posList srsDimension=\"2\" count=\"11\">50363.54 387915.31 50384.68 387925.31 50396.07 387949.41 50395.17 387958.22 50389.45 387966.56 50370.98 387980.96 50350.95 387964.19 50342.17 387949.04 50343.07 387939.31 50350.83 387915.59 50363.54 387915.31</posList></LineStringSegment></segments></Curve></curveMember></Ring></exterior></PolygonPatch></patches></Surface>";
        GeometryConverter gc = new GeometryConverter();
        Element node = getElement(xml);
        MultiPolygon mp = gc.convertMultiPolygonGeometry(node);
        assertNotNull(mp);
        assertFalse(mp.isEmpty());
    }

    @Test
    public void testGeometryEnkelbestemming2008Parsing() throws SAXException, IOException, ParserConfigurationException, TransformerException {
        // 2008enkelbestemming
        String xml = "<MultiSurface srsName=\"urn:ogc:def:crs:EPSG::28992\"><surfaceMembers><Surface srsName=\"urn:ogc:def:crs:EPSG::28992\"><patches><PolygonPatch><exterior><Ring><curveMember><Curve><segments><LineStringSegment><posList srsDimension=\"2\" count=\"124\">50660.9 388261.1 50666.387 388267.768 50668.609 388271.176 50651.631 388285.589 50636.94 388268.27 50594.91 388216.62 50592.305 388213.306 50587.87 388207.71 50532.58 388146.11 50516.96 388129.27 50485.65 388095 50470.59 388114.43 50442.748 388150.803 50404.519 388123.988 50369.311 388099.292 50397.959 388059.749 50396.26 388058.43 50391.51 388054.72 50381.24 388048.79 50376.24 388045.88 50369.58 388042.53 50353.33 388034.31 50344.65 388029.93 50340.574 388035.175 50339.07 388037.11 50331.72 388041.64 50323.15 388053.49 50310.62 388044.52 50289.138 388029.141 50283.074 388036.928 50265.16 388059.93 50247.801 388082.22 50224.285 388112.416 50197.04 388147.4 50189.326 388142.343 50165.151 388123.635 50099.12 388070.71 50096.13 388068.24 50032.46 388017.29 50041.276 388000 50078.082 387927.817 50104.31 387876.38 50198.73 387691.18 50200.33 387688.1 50205.43 387677.49 50207.397 387661.255 50230.012 387672.932 50241.108 387678.239 50250.55 387682.134 50260.381 387686.012 50268.25 387689.7 50272.678 387680.562 50277.404 387671.636 50282.083 387662.798 50286.049 387665.461 50290.302 387668.446 50321.62 387690.43 50343.23 387705.6 50360.39 387717.65 50366.24 387721.755 50369.67 387717.17 50386.23 387695.34 50400.17 387676.89 50402.12 387674.32 50419.23 387654.97 50418.204 387654.257 50431.955 387638.235 50440.688 387628.062 50466.495 387645.857 50464.388 387647.9 50461.303 387652.302 50465.9 387655.46 50462.84 387659.39 50467.93 387664.63 50491.72 387683.83 50489 387687.27 50475.79 387703.95 50462.63 387720.57 50449.43 387737.24 50446.61 387735.33 50425.97 387764.33 50418.11 387775.37 50417.08 387776.82 50408.67 387788.65 50400.55 387800.06 50392.44 387811.46 50435.02 387827.17 50439.32 387843.91 50439.15 387852.57 50434.97 387865.44 50428.96 387874.39 50425.933 387877.652 50475.41 387945.34 50517.11 387965.36 50525.86 387969.56 50515.79 387985.73 50513.97 387988.65 50515.87 387990.42 50526.162 388000 50534.8 388008.04 50565.06 388036.36 50552.64 388049.91 50566.8 388067.11 50582.09 388085.7 50570.12 388100.86 50585.383 388115.81 50600.43 388130.55 50628.488 388158.168 50626.46 388160.09 50620.25 388161.47 50634.44 388168.26 50653.06 388178.49 50666.75 388188.3 50685.01 388202.46 50698.96 388212.88 50705.05 388218.31 50707.26 388222.05 50706.06 388226.8 50712.33 388224.73 50709.27 388235.44 50692.73 388241.49 50684.28 388244.96 50672.4 388251.79 50660.9 388261.1</posList></LineStringSegment></segments></Curve></curveMember></Ring></exterior></PolygonPatch></patches></Surface></surfaceMembers></MultiSurface>";
        GeometryConverter gc = new GeometryConverter();

        Element node = getElement(xml);
        MultiPolygon mp = gc.convertMultiPolygonGeometry(node);
        assertNotNull(mp);
        assertFalse(mp.isEmpty());
    }

    @Test
    public void testGeometryBestemmingsplangebied2008Parsing() throws SAXException, IOException, ParserConfigurationException, TransformerException {
        // 2008bestemmingsplangebied
        String xml = "<Surface srsName=\"urn:ogc:def:crs:EPSG::28992\"><patches><PolygonPatch><exterior><LinearRing><posList>251842.151 560971.892 251842.818 560970.025 251853.361 560931.431 251865.118 560889.547 251872.053 560862.283 251876.918 560844.747 251879.824 560834.095 251890.652 560798.293 251893.863 560790.058 251894.526 560788.358 251899.331 560778.853 251903.859 560771.283 251910.094 560761.92 251919.436 560750.57 251927.769 560741.911 251935.295 560735.744 251942.915 560730.678 251953.636 560725.321 251964.353 560721.361 251977.468 560717.908 251988.279 560715.646 251998.887 560713.984 252003.131 560713.52 252004.954 560696.917 252017.064 560588.14 252019.065 560552.329 252034.571 560552.594 252073.278 560552.522 252090.377 560551.996 252156.508 560552.085 252174.834 560552.211 252257.53 560552.526 252371.983 560552.632 252392.256 560552.682 252399.69 560552.7 252405.66 560631.97 252405.54 560647.36 252401.01 560691.02 252397.61 560729.2 252389.825 560756.904 252420.076 560766.62 252429.974 560771.215 252440.274 560776.708 252446.523 560780.959 252457.975 560789.695 252460.575 560792.192 252464.977 560797.789 252469.178 560802.585 252474.88 560811.179 252479.883 560819.274 252486.288 560831.467 252488.09 560836.665 252489.291 560840.763 252490.694 560844.76 252497.308 560874.649 252503.518 560898.938 252507.223 560909.733 252511.526 560919.728 252514.728 560925.124 252517.13 560929.922 252517.625 560930.63 252518.529 560931.92 252522.432 560938.716 252527.323 560946.043 252528.935 560948.61 252535.537 560957.904 252538.187 560961.019 252543.439 560966.598 252546.438 560969.395 252549.238 560971.594 252553.638 560974.591 252560.739 560978.386 252568.337 560982.181 252578.737 560987.775 252604.535 561001.06 252632.955 561013.861 252637.789 561016.001 252652.909 561021.189 252664.348 561024.339 252676.961 561025.862 252665.965 561055.323 252666.859 561055.687 252714.26 561074.99 252755.62 561091.87 252770.781 561098.058 252782.55 561090.55 252790.09 561087.04 252799.36 561083.91 252824.15 561078.24 252857.97 561071.96 252884.45 561067.65 252903.92 561065.34 252730.372 561277.248 252731.453 561277.851 252721.569 561289.886 252694.642 561323.36 252632.415 561401.687 252597.6 561444.788 252593.463 561449.916 252576.76 561470.623 252553.837 561501.21 252533.07 561529.27 252525.362 561539.113 252504.833 561563.252 252495.088 561573.953 252412.966 561524.384 252315.504 561465.73 252337.83 561424.776 252330.409 561419.929 252186.595 561331.096 251858.516 561128.527 251848.258 561122.194 251853.957 561100.997 251873.689 561019.355 251878.927 560990.304 251869.903 560986.038 251842.151 560971.892</posList></LinearRing></exterior></PolygonPatch></patches></Surface> ";
        GeometryConverter gc = new GeometryConverter();

        Element node = getElement(xml);
        MultiPolygon mp = gc.convertMultiPolygonGeometry(node);
        assertNotNull(mp);
        assertFalse(mp.isEmpty());
    }

    @Test
    public void testJosePolygon() throws SAXException, IOException, ParserConfigurationException, TransformerException {
        String xml = "<gml:Polygon xmlns:gml=\"http://www.opengis.net/gml/3.2\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.opengis.net/gml/3.2 http://schemas.opengis.net/gml/3.2.1/gml.xsd\" gml:id=\"GSE001\"><gml:exterior><gml:Ring><gml:curveMember><gml:LineString gml:id=\"GSE002\"><gml:coordinates cs=\" \" ts=\" \">20.6275752990001 69.0458485340001 23.6522989730001 67.9591256830001 23.394147676 67.4853849730001 23.7645843610001 67.4282118410001 23.5511838610001 67.171321484 23.995291303 66.8217779030001 23.6458027940001 66.3015228150001 24.1776751290001 65.6603581030001 23.8992902910001 65.363938606 23.1222006670001 65.2873440590001 21.8152155180001 64.8360917040001 22.099123046 64.4539134830001 21.3948099770001 63.9560658770001 21.3725223480001 63.6351714200001 20.097484583 63.163352188 19.4093118760001 63.068044048 18.2875747670001 62.4174439930001 18.0643892840001 61.9889935410001 17.883996095 60.9361734680001 19.1048713440001 60.6303523110001 19.118231322 60.073555147 19.991083185 59.5595338790001 19.816309173 59.2938278990001 18.9407839030001 58.8569371410001 17.5617016180001 58.396982409 17.2509618060001 57.614452509 17.6063095360001 57.349279976 18.1743547990001 57.9478307260001 18.9872553610001 58.177281001 18.7971457340001 58.4280731210001 19.1178240500001 58.5937904720001 19.6780403080001 58.44086136 19.7036982210001 57.8930463090001 19.3030909770001 57.5766251890001 19.3544883810001 57.3589766740001 18.5284181070001 56.7710770250001 17.8834277610001 56.758222791 17.4898702400001 57.2317293520001 16.6072220550001 56.0283846240001 15.7667531740001 55.751910502 15.152757147 55.8982079070001 14.5944246270001 55.755000302 14.7016791680001 55.6034274630001 14.1722953990001 55.177492537 12.9247851440001 55.148989542 12.6121940250001 55.4320428880001 12.8957081780001 55.64353357 12.6525834940001 56.0457802180001 12.1174567820001 56.3831608610001 12.2974291680001 56.6364623520001 11.2025644020001 57.674656364 10.592075917 58.760985131 11.3399133590001 59.114979066 11.4574487390001 58.8884361220001 11.652005021 58.9062336490001 11.8397152050001 59.8407838300001 12.3411394010001 59.9656698890001 12.541907601 60.193378733 12.6068834610001 60.5127437800001 12.223992303 61.0130781190001 12.6814029960001 61.0595377940001 12.8708379260001 61.35649483 12.1376663360001 61.7238176260001 12.2993694230001 62.2674935150001 11.9745828370001 63.2692271230001 12.683566484 63.974222475 13.2111085380001 64.0953681140001 13.9675251440001 64.007968766 14.157109645 64.1950531990001 14.1138697580001 64.462483723 13.6542581190001 64.5803397670001 14.5068320140001 65.3097281190001 14.516287386 66.132577573 15.484729385 66.282457526 15.3772232190001 66.4843027150001 16.387754896 67.0454610790001 16.0898237740001 67.4352772250001 16.7381138730001 67.914208257 17.2815163380001 68.1188137410001 17.8997572840001 67.9693709380001 18.405678815 68.5818759750001 19.9213869880001 68.3560124810001 20.3358613110001 68.8023123440001 20.0600357110001 69.045758543 20.6275752990001 69.0458485340001</gml:coordinates></gml:LineString></gml:curveMember></gml:Ring></gml:exterior></gml:Polygon>";
        GeometryConverter gc = new GeometryConverter();

        Element node = getElement(xml);
        MultiPolygon mp = gc.convertMultiPolygonGeometry(node);
        assertNotNull(mp);
        assertFalse(mp.isEmpty());
    }

    @Test
    public void testArc() throws SAXException, IOException, ParserConfigurationException, TransformerException {
        String xml = "<gml:Surface srsName=\"urn:ogc:def:crs:EPSG::28992\"><gml:patches><gml:PolygonPatch><gml:exterior><gml:Ring><gml:curveMember><gml:Curve><gml:segments><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"2\">50385.966 387915.948 50386.487 387916.631</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50386.487 387916.631 50388.01 387918.87 50389.176 387920.735</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50389.176 387920.735 50395.44 387932.173 50398.886 387943.816</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50398.886 387943.816 50398.995 387952.201 50398.104 387959.735</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50398.104 387959.735 50397.118 387963.296 50395.496 387966.376</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"5\">50395.496 387966.376 50388.199 387977.348 50385.946 387980.705 50385.322 387981.649 50380.398 387989.013</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50380.398 387989.013 50378.852 387989.822 50377.3 387989.17</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"4\">50377.3 387989.17 50376.658 387988.649 50362.601 387977.081 50348.558 387965.48</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50348.558 387965.48 50342.187 387956.004 50340.021 387945.49</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50340.021 387945.49 50340.185 387943.41 50340.462 387941.575</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50340.462 387941.575 50340.88 387939.383 50341.339 387937.604</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"11\">50341.339 387937.604 50341.474 387937.181 50348.194 387918.318 50350.706 387911.138 50351.027 387910.22 50351.585 387908.626 50354.229 387901.144 50354.604 387900.084 50354.766 387899.611 50354.929 387899.138 50355.428 387897.686</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50355.428 387897.686 50358.234 387894.974 50361.865 387896.031</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"3\">50361.865 387896.031 50370.535 387902.837 50381.596 387911.555</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50381.596 387911.555 50383.979 387913.719 50385.966 387915.948</gml:posList></gml:Arc></gml:segments></gml:Curve></gml:curveMember></gml:Ring></gml:exterior><gml:interior><gml:Ring><gml:curveMember><gml:Curve><gml:segments><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"11\">50343.07 387939.31 50342.17 387949.04 50350.95 387964.19 50370.98 387980.96 50389.45 387966.56 50395.17 387958.22 50396.07 387949.41 50384.68 387925.31 50363.54 387915.31 50350.83 387915.59 50343.07 387939.31</gml:posList></gml:LineStringSegment></gml:segments></gml:Curve></gml:curveMember></gml:Ring></gml:interior></gml:PolygonPatch></gml:patches></gml:Surface>";

        GeometryConverter gc = new GeometryConverter();

        Element node = getElement(xml);
        MultiPolygon mp = gc.convertMultiPolygonGeometry(node);
        assertNotNull(mp);
        assertFalse(mp.isEmpty());
    }

    @Test
    public void testMultipleHoles() throws SAXException, IOException, ParserConfigurationException, TransformerException {
        String xml = "<gml:Surface srsName=\"urn:ogc:def:crs:EPSG::28992\"><gml:patches><gml:PolygonPatch><gml:exterior><gml:Ring><gml:curveMember><gml:Curve><gml:segments><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"11\">50250.55 387682.134 50260.381 387686.012 50268.25 387689.7 50280.52 387694.83 50289.65 387699.52 50299.1 387704.9 50307.59 387710.39 50329.15 387725.59 50346.28 387737.67 50363.44 387749.76 50378.02 387760.04</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50378.02 387760.04 50379.279 387760.71 50380.335 387761.144</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50380.335 387761.144 50381.902 387761.601 50383.25 387761.83</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"99\">50383.25 387761.83 50397.39 387743.62 50400.09 387739.93 50416.8 387718.56 50432.18 387698.76 50437.71 387691.64 50449.16 387676.92 50454.02 387670.67 50462.25 387660.15 50462.84 387659.39 50467.93 387664.63 50465.19 387667.45 50457.45 387676.58 50451.2 387684.85 50437.16 387703.39 50424.38 387720.26 50403.82 387747.55 50393.79 387760.78 50385.41 387771.84 50376.94 387783.01 50369.87 387792.34 50368.41 387794.78 50366.02 387804.97 50365.95 387806.05 50365.82 387810.4 50364.86 387837.37 50364.19 387855.6 50363.65 387873.65 50363.21 387888.2 50363.71 387889.72 50375.73 387899.27 50379.725 387902.441 50392.344 387912.491 50393.475 387914.32 50401.676 387927.575 50403.263 387930.14 50407.868 387939.682 50410.394 387948.888 50411.624 387958.277 50409.667 387963.129 50408.28 387962.57 50404.02 387973.27 50403.177 387975.388 50401.745 387974.688 50389.22 387992.29 50394.3 388001.8 50425.58 388027.36 50426.75 388025.63 50438.69 388035.63 50455.04 388049.32 50460.35 388053.78 50475.04 388032.63 50477.047 388026.552 50477.8 388024.27 50486.64 388011.04 50491.06 388006.57 50491.846 388005.964 50495.26 388003.33 50497.77 388000.52 50498.4 387999.695 50501.09 387996.17 50508.329 387983.399 50515.77 387970.27 50517.11 387965.36 50525.86 387969.56 50515.79 387985.73 50513.97 387988.65 50515.87 387990.42 50511.154 388000 50508.37 388005.66 50495.49 388019.3 50486.7 388026.73 50475.19 388041.8 50470.88 388048.61 50465.1 388057.65 50480.05 388068.82 50493.36 388080.07 50502.17 388088.19 50522.57 388109.29 50540.75 388128.7 50553.044 388141.881 50556.217 388145.283 50571.38 388161.54 50583.12 388174.11 50586.66 388177.92 50601.78 388195.18 50614.63 388210.2 50623.01 388220.27 50640.6 388240.26 50644.09 388240.81 50652.74 388242.12 50657.76 388242.25 50664.7 388241.49 50669.53 388240.96 50688.87 388232.75 50703.372 388227.73 50704.249 388229.923 50704.989 388232.06 50666.516 388247.269</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50666.516 388247.269 50660.549 388249.106 50655.915 388252.342</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50655.915 388252.342 50652.135 388257.311 50650.284 388262.484</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"12\">50650.284 388262.484 50650.253 388262.641 50650.805 388263.829 50655.556 388269.298 50659.345 388273.593 50662.136 388276.671 50657.723 388280.418 50655.225 388277.432 50642.612 388262.358 50628.537 388244.949 50625.575 388241.36 50594.955 388204.255</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50594.955 388204.255 50587.942 388195.995 50582.561 388189.947</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"14\">50582.561 388189.947 50550.246 388154.558 50541.473 388145.194 50538.365 388141.733 50524.859 388127.02 50508.485 388109.31 50496.623 388097.146 50496.426 388096.96 50494.242 388094.899 50493.91 388094.586 50484.854 388085.889 50478.929 388080.688 50471.094 388073.907 50460.364 388064.935</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50460.364 388064.935 50458.627 388064.448 50456.968 388064.545</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50456.968 388064.545 50455.578 388065.068 50454.439 388065.911</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"3\">50454.439 388065.911 50451.366 388069.656 50445.726 388077.997</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50445.726 388077.997 50431.323 388098.79 50423.804 388109.595</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"19\">50423.804 388109.595 50414.232 388122.769 50412.031 388125.8 50410.36 388128.085 50407.988 388126.421 50409.611 388124.312 50411.085 388122.397 50411.979 388121.132 50415.996 388115.447 50416.038 388114.867 50422.832 388104.874 50423.552 388104.127 50424.384 388103.66 50433.956 388089.959 50438.305 388083.708 50445.44 388073.233 50445.976 388072.486 50450.231 388066.084 50450.25 388065.551</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50450.25 388065.551 50451.235 388063.517 50451.775 388061.416</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"59\">50451.775 388061.416 50449.91 388059.94 50448.57 388058.87 50442.1 388053.15 50441.04 388052.29 50417.4 388033.13 50416.85 388033.81 50415.92 388033.04 50411.279 388029.261 50401.39 388021.21 50396.99 388017.62 50397.03 388017.58 50389.5 388011.43 50389.33 388011.64 50388.575 388010.993 50377.954 388001.893 50377.88 388001.83 50377.82 388001.92 50370.56 387995.96 50371.24 387995.16 50368.05 387992.75 50365.14 387990.54 50365.088 387990.522 50352.88 387981.26 50345.68 387975.41 50342.81 387972.94 50340.62 387970.86 50338.76 387968.81 50336.43 387965.75 50334.8 387963.16 50333.49 387960.39 50332.45 387957.91 50324.77 387954.26 50318.22 387951.15 50301.93 387943.43 50287.67 387936.69 50271.61 387929.09 50239.07 387912.92 50208.83 387895.13 50207.42 387894.33 50207.05 387891.81 50197.043 387885.901 50183.63 387877.98 50181.13 387878.92 50157.97 387870.27 50153.6 387881.55 50149.751 387892.586 50146.412 387902.134 50142.589 387913.065 50136.253 387931.014 50140.338 387936.532 50152.473 387944.489 50170.17 387956.052 50183.069 387931.999 50183.595 387934.042 50184.564 387933.985 50185.839 387934.233 50187.693 387935.329 50194.395 387939.162</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50194.395 387939.162 50195.583 387940.957 50195.975 387942.979</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"3\">50195.975 387942.979 50195.675 387944.008 50187.031 387971.208</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50187.031 387971.208 50186.744 387972.847 50187.463 387974.217</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"4\">50187.463 387974.217 50192.55 387982.887 50195.485 387988.114 50197.015 387990.693</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50197.015 387990.693 50198.992 387993.732 50200.964 387996.468</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50200.964 387996.468 50202.598 387998.379 50204.133 388000</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50204.133 388000 50205.248 388001.085 50206.279 388002.027</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"5\">50206.279 388002.027 50212.577 388007.452 50213.995 388008.571 50215.292 388009.577 50217.106 388010.872</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50217.106 388010.872 50227.642 388016.932 50237.339 388021.051</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"9\">50237.339 388021.051 50238.89 388021.584 50247.535 388024.202 50251.529 388025.662 50255.377 388027.218 50263.351 388030.693 50266.043 388031.939 50268.678 388033.368 50271.643 388035.255</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50271.643 388035.255 50272.902 388036.068 50274.123 388036.89</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"7\">50274.123 388036.89 50276.569 388038.49 50280.073 388040.781 50274.568 388047.849 50271.017 388045.503 50266.316 388042.414 50265.181 388041.704</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50265.181 388041.704 50261.496 388039.592 50257.985 388037.968</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"2\">50257.985 388037.968 50250.025 388034.566</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50250.025 388034.566 50246.107 388033.047 50242.35 388031.792</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"2\">50242.35 388031.792 50237.549 388030.388</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50237.549 388030.388 50229.039 388027.248 50222.908 388024.434</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"4\">50222.908 388024.434 50218.317 388022.059 50214.247 388019.59 50209.011 388016.152</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50209.011 388016.152 50204.132 388015.286 50199.512 388016.822</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50199.512 388016.822 50198.64 388017.445 50197.988 388018.014</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50197.988 388018.014 50194.761 388021.366 50191.418 388024.228</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"4\">50191.418 388024.228 50189.225 388025.708 50179.003 388032.667 50170.74 388038.291</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50170.74 388038.291 50166.995 388044.676 50169.728 388051.304</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"8\">50169.728 388051.304 50185.658 388064.016 50171.424 388082.663 50154.682 388069.315 50147.675 388063.805 50146.491 388062.85 50146.043 388062.448 50145.969 388062.54</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50145.969 388062.54 50144.503 388059.476 50145.427 388056.213</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"6\">50145.427 388056.213 50146.918 388054.233 50158.417 388039.703 50165.968 388030.886 50174.986 388024.833 50186.314 388017.205</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50186.314 388017.205 50189.345 388014.526 50191.723 388011.695</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"2\">50191.723 388011.695 50191.889 388011.462</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50191.889 388011.462 50193.507 388008.708 50194.332 388005.907</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50194.332 388005.907 50193.825 388002.99 50192.867 388000.363</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"6\">50192.867 388000.363 50192.633 388000 50190.368 387996.491 50185.233 387988.078 50184.64 387987.038 50180.483 387979.748</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50180.483 387979.748 50176.299 387973.586 50172.061 387968.935</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"36\">50172.061 387968.935 50171.724 387969.533 50149.712 387955.025 50141.683 387967.356 50132.78 387981.182 50131.332 387991.519 50131.418 387992.392 50131.886 387993.041 50135.191 387995.698 50119.458 388015.214 50109.112 388006.915 50106.816 388005.073 50108.197 388003.36 50122.635 387985.448 50122.259 387984.414 50138.208 387959.427 50140.902 387955.207 50143.593 387950.992 50124.746 387938.571 50127.516 387930.675 50136.11 387906.174 50141.864 387889.773 50144.56 387882.09 50150.13 387866.06 50151.617 387861.859 50135.452 387852.137 50137.217 387848.671 50145.22 387853.5 50148.73 387855.75 50154.382 387857.876 50163.804 387861.419 50173.224 387864.962 50184.52 387869.21 50194.63 387848.95 50200.13 387837.94 50203.26 387831.68</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50203.26 387831.68 50203.548 387830.202 50203.07 387828.83</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"5\">50203.07 387828.83 50201.62 387826.19 50193.02 387812.64 50188.98 387806.25 50185.2 387805.97</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50185.2 387805.97 50182.222 387805.421 50179.53 387804.23</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"22\">50179.53 387804.23 50172.21 387800.48 50165.154 387796.855 50166.604 387794.042 50180.801 387801.525 50181.752 387799.679 50183.19 387800.42 50191.63 387783.93 50200.78 387766.11 50209.54 387749.08 50216.47 387735.57 50218.61 387731.48 50220.224 387728.825 50222.09 387726.34 50224.146 387724.462 50226.45 387722.9 50226.936 387722.665 50227.484 387722.452 50232.136 387720.84 50233.542 387720.33 50237.164 387719.212 50237.42 387719.129</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50237.42 387719.129 50241.399 387716.837 50244.061 387713.411</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"21\">50244.061 387713.411 50244.744 387712.196 50245.765 387709.757 50246.037 387709.039 50252.063 387693.091 50251.968 387692.828 50250.206 387690.646 50247.01 387688.675 50243.896 387687.466 50239.186 387685.637 50232.166 387682.691 50225.375 387679.406 50221.859 387677.704 50214.223 387673.979 50206.353 387669.876 50207.397 387661.255 50210.018 387662.587 50221.77 387668.773 50230.012 387672.932 50241.108 387678.239 50250.55 387682.134</gml:posList></gml:LineStringSegment></gml:segments></gml:Curve></gml:curveMember></gml:Ring></gml:exterior><gml:interior><gml:Ring><gml:curveMember><gml:Curve><gml:segments><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"2\">50386.487 387916.631 50385.966 387915.948</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50385.966 387915.948 50383.815 387913.554 50381.596 387911.555</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"3\">50381.596 387911.555 50370.535 387902.837 50361.865 387896.031</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50361.865 387896.031 50358.099 387895.009 50355.428 387897.686</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"11\">50355.428 387897.686 50354.929 387899.138 50354.766 387899.611 50354.604 387900.084 50354.229 387901.144 50351.585 387908.626 50351.027 387910.22 50350.706 387911.138 50348.194 387918.318 50341.474 387937.181 50341.339 387937.604</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50341.339 387937.604 50340.795 387939.768 50340.462 387941.575</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50340.462 387941.575 50340.159 387943.64 50340.021 387945.49</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50340.021 387945.49 50342.461 387956.645 50348.558 387965.48</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"4\">50348.558 387965.48 50362.601 387977.081 50376.658 387988.649 50377.3 387989.17</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50377.3 387989.17 50378.92 387989.819 50380.398 387989.013</gml:posList></gml:Arc><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"5\">50380.398 387989.013 50385.322 387981.649 50385.946 387980.705 50388.199 387977.348 50395.496 387966.376</gml:posList></gml:LineStringSegment><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50395.496 387966.376 50397.197 387963.096 50398.104 387959.735</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50398.104 387959.735 50399.034 387951.401 50398.886 387943.816</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50398.886 387943.816 50395.09 387931.34 50389.176 387920.735</gml:posList></gml:Arc><gml:Arc><gml:posList srsDimension=\"2\" count=\"3\">50389.176 387920.735 50387.731 387918.445 50386.487 387916.631</gml:posList></gml:Arc></gml:segments></gml:Curve></gml:curveMember></gml:Ring></gml:interior><gml:interior><gml:Ring><gml:curveMember><gml:Curve><gml:segments><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"45\">50338.518 387776.807 50357.781 387790.99 50373.305 387770.446 50373.07 387769.53 50371.91 387767.69 50370.47 387766.5 50352.27 387753.84 50329.19 387737.39 50321.39 387731.85 50306.25 387723.06 50281.98 387708.98 50266.09 387699.74 50264.87 387699.07 50263.582 387699.141 50262.322 387699.417 50261.513 387699.711 50260.74 387700.09 50259.679 387700.859 50258.91 387701.92 50258.259 387703.475 50252.92 387716.23 50251.447 387718.919 50249.62 387721.38 50250.809 387722.262 50248.13 387727.48 50250.35 387735.22 50261.35 387751.61 50264.41 387761.32 50269.27 387776.39 50275.68 387790.41 50280.31 387795.29 50285.57 387799.13 50290.97 387801.26 50296.66 387801.53 50300.75 387800.03 50305.04 387797.79 50309.66 387793.13 50312.84 387789.6 50320.05 387782.68 50325.92 387779.65 50330.23 387778.318 50334.62 387777.28 50336.24 387775.13 50337.712 387776.214 50338.518 387776.807</gml:posList></gml:LineStringSegment></gml:segments></gml:Curve></gml:curveMember></gml:Ring></gml:interior><gml:interior><gml:Ring><gml:curveMember><gml:Curve><gml:segments><gml:LineStringSegment><gml:posList srsDimension=\"2\" count=\"84\">50231.385 387815.879 50231.27 387815.99 50238.72 387823.75 50233.61 387834.2 50233.378 387834.674 50219.97 387827.86 50215.78 387830.6 50214.78 387831.88 50208.13 387844.93 50196.13 387868.93 50216.767 387881.377 50216.3 387882.17 50214.32 387885.53 50214.62 387885.7 50243.2 387902.46 50243.86 387901.33 50245.49 387902.06 50267.61 387912.52 50285.71 387921.09 50301.4 387928.51 50301.694 387927.866 50306.785 387929.243 50315.539 387931.611 50328.147 387935.021 50330.94 387936.56 50331.76 387934.18 50335.6 387922.966 50339.2 387912.45 50340.91 387907.46 50344.54 387896.92 50345.12 387895.24 50351.41 387877.92 50354.2 387871.85 50354.74 387872.12 50355.01 387849.36 50355.26 387828.29 50355.14 387815.09 50353.84 387813.28 50352.93 387807.51 50351.15 387803.08 50348.3 387799.07 50347.6 387798.37 50344.93 387795.7 50336.44 387788.64 50335.28 387787.05 50333.42 387786.68 50328.84 387787.51 50324.69 387789.58 50321.83 387791.62 50308.63 387806.12 50306.52 387807.56 50300.72 387814.6 50298.57 387819.24 50296.9 387818 50277.12 387803.04 50276.83 387802.82 50275.22 387800.93 50267.49 387791.83 50262.82 387781.39 50261.69 387778.87 50259.92 387767.64 50255.94 387755.74 50253 387750.69 50249.88 387745.81 50245.25 387739.95 50234.29 387727.57 50232.697 387727.952 50231.22 387728.66 50230.78 387729.55 50209.03 387772.92 50206.77 387777.5 50207.905 387778.85 50196.26 387801.5 50196.88 387803.03 50197.67 387804.48 50198.64 387806.03 50203.18 387813.21 50207.75 387820.39 50211.98 387827.05 50213.046 387827.32 50214.13 387827.509 50225.29 387820.43 50230.74 387815.19 50231.385 387815.879</gml:posList></gml:LineStringSegment></gml:segments></gml:Curve></gml:curveMember></gml:Ring></gml:interior></gml:PolygonPatch></gml:patches></gml:Surface>";

        GeometryConverter gc = new GeometryConverter();

        Element node = getElement(xml);
        MultiPolygon mp = gc.convertMultiPolygonGeometry(node);
        assertNotNull(mp);
        assertFalse(mp.isEmpty());

    }

    private Element getElement(String xml) throws SAXException, IOException, ParserConfigurationException {

        Element node = DocumentBuilderFactory
                .newInstance()
                .newDocumentBuilder()
                .parse(new ByteArrayInputStream(xml.getBytes()))
                .getDocumentElement();
        return node;
    }

}
